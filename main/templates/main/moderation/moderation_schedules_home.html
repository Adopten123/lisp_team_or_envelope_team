{% extends 'main/index.html' %}
{% load static %}
{% load ui_extras %}

{% block extra_styles %}
    <link rel="stylesheet" href="{% static 'css/moderation_forms.css' %}">
    <link rel="stylesheet" href="{% static 'css/schedule_moderation_forms.css' %}">
{% endblock %}

{% block content %}
    <section class="main-content">
        <h2 class="section-title">üóìÔ∏è –†–∞—Å–ø–∏—Å–∞–Ω–∏—è ‚Äî {{ current_university.short_name }}</h2>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <section class="user-card" style="margin-bottom:12px;">
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <a href="{% url 'schedule_slot_create' %}{% if current_group %}?group={{ current_group.id }}{% endif %}"
                   class="btn btn-indigo">–î–æ–±–∞–≤–∏—Ç—å —è—á–µ–π–∫—É (ScheduleSlot)</a>
                <a href="
                        {% url 'schedule_exception_create' %}{% if current_group %}?group={{ current_group.id }}{% endif %}"
                   class="btn btn-ghost">–î–æ–±–∞–≤–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ (ScheduleException)</a>
            </div>
        </section>

        <!-- –§–∏–ª—å—Ç—Ä—ã: –≤—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã (–ø–æ–∏—Å–∫ –ø–æ input) –∏ –Ω–µ–¥–µ–ª—è -->
        <section class="user-card" style="margin-bottom:12px;">
            <form method="get" class="filters" style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
                <select name="group" class="action-card" style="padding:10px; border-radius:10px; min-width:260px;">
                    <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É ‚Äî</option>
                    {% for g in groups %}
                        <option value="{{ g.id }}"
                                {% if current_group and g.id == current_group.id %}selected{% endif %}>
                            {{ g.name }} ¬∑ {{ g.program.name }}
                        </option>
                    {% endfor %}
                </select>

                <input type="date" name="week" value="{{ week_start|date:'Y-m-d' }}"
                       class="action-card" style="padding:10px; border-radius:10px;">
                <button class="btn btn-indigo" type="submit">–ü–æ–∫–∞–∑–∞—Ç—å</button>
                <a class="btn btn-ghost" href="{% url 'moderation_schedules' %}">–°–±—Ä–æ—Å–∏—Ç—å</a>
            </form>
        </section>

        <!-- –ü—Ä–µ–≤—å—é –Ω–µ–¥–µ–ª–∏ -->
        <section class="notifications">
            <h3 class="section-title" style="font-size:1.05rem;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ–¥–µ–ª–∏
                (—Å {{ week_start|date:"d.m.Y" }})</h3>

            {% if current_group %}
                <div class="week-grid">
                    {% for day in week_days %}
                        <div class="day-column">
                            <div class="day-head">
              <span class="day-title">
                {{ day|date:"l" }} <small>{{ day|date:"d.m" }}</small>
              </span>
                            </div>

                            <div class="day-body">
                                {% if slots_by_day.day %}
                                    {# ‚Äî —ç—Ç–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ –æ—Ç—Ä–∏—Å—É–µ–º –≤–Ω–∏–∑—É —á–µ—Ä–µ–∑ dict lookup ‚Äî #}
                                {% endif %}

                                {% for item in slots_by_day|get_item:day %}
                                    <div class="slot-card {% if item.cancelled %}slot-cancelled{% endif %}">
                                        <div class="slot-time">
                                            {% if item.cancelled %}‚Äî{% else %}{{ item.start|time:"H:i" }}‚Äì
                                                {{ item.end|time:"H:i" }}{% endif %}
                                        </div>
                                        <div class="slot-main">
                                            <div class="slot-title">
                                                {{ item.slot.teaching.curriculum.discipline.title }}
                                            </div>
                                            <div class="slot-meta">
                                                {{ item.slot.teaching.teacher.person.last_name }} {{ item.slot.teaching.teacher.person.first_name }}
                                                {% if item.building or item.room %} ¬∑ {{ item.building }}
                                                    {{ item.room }}{% endif %}
                                                {% if item.note %} ¬∑ {{ item.note }}{% endif %}
                                                {% if item.cancelled %} ¬∑ <strong>–û–¢–ú–ï–ù–ê</strong>{% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% empty %}
                                    <div class="slot-empty">–ù–µ—Ç –ø–∞—Ä</div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="notification-item">
                    <div class="notification-icon">‚ÑπÔ∏è</div>
                    <div class="notification-content">
                        <p class="notification-text">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.</p>
                    </div>
                </div>
            {% endif %}
        </section>
    </section>
{% endblock %}
